<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết chuyến bay</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: rgb(229, 236, 246);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .flight-header {
            background: linear-gradient(135deg, #0077cc, #64b5f6);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .flight-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .info-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .info-card h4 {
            margin: 0 0 10px 0;
            color: #0077cc;
        }

        .booking-section {
            padding: 30px;
        }

        .seat-map {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            max-width: 400px;
            margin: 20px auto;
        }

        .seat {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .seat.available {
            background: #e8f5e8;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .seat.available:hover {
            background: #c8e6c9;
            transform: scale(1.1);
        }

        .seat.booked {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
            cursor: not-allowed;
        }

        .seat.selected {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1565c0;
            transform: scale(1.1);
        }

        .booking-form {
            max-width: 500px;
            margin: 30px auto;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .btn-book {
            width: 100%;
            padding: 15px;
            background: #0077cc;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-book:hover {
            background: #005fa3;
        }

        .btn-book:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .message {
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            text-align: center;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .back-link {
            display: inline-block;
            margin: 20px;
            color: #0077cc;
            text-decoration: none;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<a href="javascript:history.back()" class="back-link">← Quay lại</a>

<div class="container">
    <div class="flight-header">
        <h1><%= flight.diem_di %> → <%= flight.diem_den %></h1>
        <p>Chuyến bay <%= flight.ma_cb %> - <%= flight.hang_hang_khong %></p>
    </div>

    <div class="flight-info">
        <div class="info-card">
            <h4><i class="fas fa-calendar"></i> Ngày bay</h4>
            <p><%= new Date(flight.ngay_di).toLocaleDateString('vi-VN') %></p>
        </div>
        <div class="info-card">
            <h4><i class="fas fa-clock"></i> Giờ bay</h4>
            <p><%= flight.gio_di %> - <%= flight.gio_den %></p>
        </div>
        <div class="info-card">
            <h4><i class="fas fa-plane"></i> Loại máy bay</h4>
            <p><%= flight.loai_may_bay %></p>
        </div>
        <div class="info-card">
            <h4><i class="fas fa-money-bill"></i> Giá vé</h4>
            <p style="color: #e91e63; font-weight: bold; font-size: 18px;">
                <%= new Intl.NumberFormat('vi-VN').format(flight.gia) %> đ
            </p>
        </div>
    </div>

    <div class="booking-section">
        <h3 style="text-align: center; margin-bottom: 20px;">Chọn ghế ngồi</h3>
        
        <div id="message-container"></div>

        <div class="seat-map" id="seat-map">
            <!-- Seats will be generated by JavaScript -->
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <span style="margin-right: 20px;">
                <span class="seat available" style="display: inline-block; margin-right: 5px;"></span>
                Còn trống
            </span>
            <span style="margin-right: 20px;">
                <span class="seat booked" style="display: inline-block; margin-right: 5px;"></span>
                Đã đặt
            </span>
            <span>
                <span class="seat selected" style="display: inline-block; margin-right: 5px;"></span>
                Đã chọn
            </span>
        </div>

        <form class="booking-form" id="booking-form">
            <input type="hidden" name="chuyen_bay_id" value="<%= flight.id %>">
            
            <div class="form-group">
                <label for="danh_xung">Danh xưng:</label>
                <select name="danh_xung" id="danh_xung" required>
                    <option value="">Chọn danh xưng</option>
                    <option value="Ông">Ông</option>
                    <option value="Bà">Bà</option>
                    <option value="Cô">Cô</option>
                </select>
            </div>

            <div class="form-group">
                <label for="ten_nguoi_dat">Họ và tên:</label>
                <input type="text" name="ten_nguoi_dat" id="ten_nguoi_dat" required>
            </div>

            <div class="form-group">
                <label for="sdt">Số điện thoại:</label>
                <input type="tel" name="sdt" id="sdt" required>
            </div>

            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" name="email" id="email" required>
            </div>

            <div class="form-group">
                <label for="cccd">CCCD/CMND:</label>
                <input type="text" name="cccd" id="cccd" required>
            </div>

            <div class="form-group">
                <label for="ghe_so">Ghế đã chọn:</label>
                <input type="text" name="ghe_so" id="ghe_so" readonly required>
            </div>

            <button type="submit" class="btn-book" id="btn-book" disabled>
                Đặt vé ngay
            </button>
        </form>
    </div>
</div>

<script>
    const bookedSeats = <%- JSON.stringify(bookedSeats) %>;
    const totalSeats = <%= flight.tong_ghe %>;
    let selectedSeat = null;

    // Generate seat map
    function generateSeatMap() {
        const seatMap = document.getElementById('seat-map');
        seatMap.innerHTML = '';

        for (let i = 1; i <= totalSeats; i++) {
            const seatNumber = 'G' + i;
            const seat = document.createElement('div');
            seat.className = 'seat';
            seat.textContent = seatNumber;
            seat.dataset.seat = seatNumber;

            if (bookedSeats.includes(seatNumber)) {
                seat.classList.add('booked');
            } else {
                seat.classList.add('available');
                seat.addEventListener('click', () => selectSeat(seatNumber, seat));
            }

            seatMap.appendChild(seat);
        }
    }

    // Select seat
    function selectSeat(seatNumber, seatElement) {
        // Remove previous selection
        document.querySelectorAll('.seat.selected').forEach(seat => {
            seat.classList.remove('selected');
            seat.classList.add('available');
        });

        // Select new seat
        seatElement.classList.remove('available');
        seatElement.classList.add('selected');
        selectedSeat = seatNumber;

        // Update form
        document.getElementById('ghe_so').value = seatNumber;
        document.getElementById('btn-book').disabled = false;
    }

    // Handle form submission
    document.getElementById('booking-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!selectedSeat) {
            showMessage('Vui lòng chọn ghế!', 'error');
            return;
        }

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/dat-ve', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            
            if (result.success) {
                showMessage(result.message, 'success');
                // Mark seat as booked
                bookedSeats.push(selectedSeat);
                generateSeatMap();
                selectedSeat = null;
                document.getElementById('booking-form').reset();
                document.getElementById('btn-book').disabled = true;
            } else {
                showMessage(result.message, 'error');
            }
        } catch (error) {
            showMessage('Có lỗi xảy ra, vui lòng thử lại!', 'error');
        }
    });

    // Show message
    function showMessage(message, type) {
        const container = document.getElementById('message-container');
        container.innerHTML = `<div class="message ${type}">${message}</div>`;
        
        setTimeout(() => {
            container.innerHTML = '';
        }, 5000);
    }

    // Initialize
    generateSeatMap();
</script>

</body>
</html>